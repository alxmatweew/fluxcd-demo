apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: vector
  namespace: vector
spec:
  interval: 5m
  chart:
    spec:
      chart: vector  # Название чарта
      version: "0.42.1" # Версия чарта (опционально)
      sourceRef:
        kind: HelmRepository
        name: vector-repo
        namespace: flux-system
      interval: 1m
  values:
    # Основные настройки
    role: Agent
    service:
      enabled: false
    
    # Сетевые настройки
    # hostNetwork: true
    podHostNetwork: true
    dnsPolicy: ClusterFirstWithHostNet
    
    # Обход taints control-plane
    tolerations:
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"
    - key: "node-role.kubernetes.io/master"
      operator: "Exists"
      effect: "NoSchedule"
    
    # Запуск только на control-plane нодах
    nodeSelector:
      node-role.kubernetes.io/control-plane: ""
    
    # Конфигурация Vector
    customConfig:
      sources:
        # # Kube Controller Manager
        # kube_controller_manager:
        #   type: prometheus_scrape
        #   endpoints: ["https://127.0.0.1:10257/metrics"]
        #   bearer_token: "/var/run/secrets/kubernetes.io/serviceaccount/token"
        #   scrape_interval_secs: 5
        #   tls:
        #     verify_certificate: false
        # # Kube Scheduler (добавлен)
        # kube_scheduler:
        #   type: prometheus_scrape
        #   endpoints: ["https://127.0.0.1:10259/metrics"]
        #   bearer_token: "/var/run/secrets/kubernetes.io/serviceaccount/token"          
        #   scrape_interval_secs: 5
        #   tls:
        #     verify_certificate: false
        # ETCD
        kube_etcd:
          type: prometheus_scrape
          endpoints: ["http://127.0.0.1:2381/metrics"]
          scrape_interval_secs: 5
      sinks:
        victoria_metrics:
          type: prometheus_remote_write
          inputs: ["kube_etcd"] #["kube_controller_manager", "kube_scheduler", "kube_etcd"]
          endpoint: "http://vmsingle-victoria-metrics-vm.vm.svc.cluster.local:8429/api/v1/write"
          healthcheck:
            enabled: true
            successful_response_status: [200, 204]  # Допустимые коды ответа